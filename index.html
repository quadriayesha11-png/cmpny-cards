<script>
  const qs   = new URLSearchParams(location.search);
  const lang = qs.get('lang') === 'en' ? 'en' : 'ar';
  const id   = qs.get('id') || "";

  const $ = (id)=>document.getElementById(id);
  const setText = (id,val)=>{ const el=$(id); if(el) el.textContent = val || '—'; };

  function showError(msg){
    $('card').innerHTML = `<div class="error">${msg}</div>`;
  }

  function buildEmployeesPath(id){
    if(!id) return null;
    return `employees/${id.endsWith('.json') ? id : id + '.json'}`;
  }

  function localizeLabels(){
    if(lang === 'en'){
      document.documentElement.lang = 'en';
      document.documentElement.dir  = 'ltr';
      setText('lblPhone','Phone');
      setText('lblSite','Website');
      setText('lblEmail','Email');
      setText('lblOpenMap','Open Map');
      setText('note','Tap any row to take action (Call / Visit / Email / Map)');
    }else{
      document.documentElement.lang = 'ar';
      document.documentElement.dir  = 'rtl';
      setText('lblPhone','الهاتف');
      setText('lblSite','الموقع');
      setText('lblEmail','البريد الإلكتروني');
      setText('lblOpenMap','افتح الخريطة');
      setText('note','اضغط على أي صف لاتخاذ إجراء (اتصال / زيارة / بريد / خريطة)');
    }
    $('btnVCard').title = 'Download vCard';
  }

  function vEsc(s){ return String(s||'').replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
  function bestName(data){ return data.name || data.nameEn || data.nameAr || 'Contact'; }
  function safeFile(s){ return String(s||'Contact').replace(/[<>:"/\\|?*\u0000-\u001F]/g,'').trim() || 'Contact'; }

  function buildVCard(data){
    const fn   = data.nameEn || data.name || data.nameAr || '';
    const org  = data.company || '';
    const titl = data.titleEn || data.title || data.titleAr || '';
    const tel  = data.phone1 || data.phone || data.mobile || '';
    const mail = data.email || '';
    const url  = data.site || data.website || '';

    let last='', first='', middle='';
    if(fn){
      const parts = fn.trim().split(/\s+/);
      if(parts.length===1){ first=parts[0]; }
      else if(parts.length===2){ first=parts[0]; last=parts[1]; }
      else { first=parts[0]; last=parts[parts.length-1]; middle=parts.slice(1,-1).join(' '); }
    }

    return [
      'BEGIN:VCARD',
      'VERSION:3.0',
      `FN:${vEsc(fn || bestName(data))}`,
      `N:${vEsc(last)};${vEsc(first)};${vEsc(middle)};;`,
      titl ? `TITLE:${vEsc(titl)}` : '',
      org  ? `ORG:${vEsc(org)}` : '',
      tel  ? `TEL;TYPE=CELL,VOICE:${vEsc(tel)}` : '',
      mail ? `EMAIL;TYPE=INTERNET:${vEsc(mail)}` : '',
      url  ? `URL:${vEsc(url)}` : '',
      'END:VCARD'
    ].filter(Boolean).join('\r\n');
  }

  function downloadVCard(data){
    const vcf = buildVCard(data);
    const blob = new Blob([vcf], {type:'text/vcard;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = safeFile(bestName(data)) + '.vcf';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  async function fetchJSON(path){
    const r = await fetch(path, { cache:'no-store' });
    if(!r.ok) throw new Error('Not found');
    return r.json();
  }

  function bind(data){
    setText('name', data.nameAr || data.name || 'اسمك هنا');
    setText('designation', data.titleAr || data.title || 'مسمّاك الوظيفي');
    setText('phoneText', data.phone1 || data.phone || data.mobile || '+971 XX XXX XXXX');
    setText('emailText', data.email || 'info@example.com');

    $('btnPhone').href = data.phone1 ? `tel:${data.phone1}` : '#';
    $('btnEmail').href = data.email ? `mailto:${data.email}` : '#';
    const site = data.site || data.website || '#';
    try{ const u = new URL(site); $('btnSite').href=site; $('siteText').textContent=u.host; }
    catch{ $('btnSite').href=site; $('siteText').textContent=site; }

    $('btnVCard').onclick = ()=> downloadVCard(data);
  }

  (async function init(){
    localizeLabels();
    if(!id){ showError(lang==='en' ? 'Invalid or missing ID':'المعرّف مفقود أو غير صالح'); return; }
    try{ const data = await fetchJSON(buildEmployeesPath(id)); bind(data); }
    catch{ showError(lang==='en' ? 'Invalid or missing ID':'المعرّف مفقود أو غير صالح'); }
  })();
</script>
